[tox]
minversion = 2.0
envlist = 
    py{37,38,39}-{linux,windows}
    py{37,38,39}-{linux,windows}-requirements
    check


[testenv:py{37,38,39}-{linux,windows}]
platform = 
    linux: linux
    windows: win32
deps =
    -r{toxinidir}{/}requirements{/}{envname}-requirements.txt
    # https://github.com/pytorch/pytorch/issues/69894
    setuptools==59.5.0
    pytest
    pytest-cov
commands =
    pytest --cov={envsitepackagesdir}{/}verydeepvae --cov-append {posargs:-vv tests}
depends =
    py{37,38,39}-{linux,windows}: clean
    report: py{37,38,39}-{linux,windows}


[testenv:py{37,38,39}-{linux,windows}-requirements]
platform = 
    linux: linux
    windows: win32
deps = 
    pip-tools
skip_install = true
commands=
    pip-compile --output-file {toxinidir}{/}requirements{/}{envname}.txt


[testenv:check]
deps =
    check-manifest
    twine
    flake8
skip_install = true
commands =
    python setup.py sdist --formats=gztar
    twine check dist/*.tar.gz
    check-manifest {toxinidir}
    flake8  --extend-ignore "E203 E501"

[testenv:report]
deps = coverage
skip_install = true
commands =
    coverage report
    coverage html


[testenv:clean]
deps = coverage
skip_install = true
allowlist_externals =
    linux: rm
commands = 
    coverage erase
    linux: rm -rf htmlcov